<?php
/**
 * Rollpix ProductGallery - Gallery Template
 *
 * @category  Rollpix
 * @package   Rollpix_ProductGallery
 * @var \Magento\Catalog\Block\Product\View\Gallery $block
 * @var \Rollpix\ProductGallery\ViewModel\GalleryConfig $galleryConfig
 */

declare(strict_types=1);

/** @var \Magento\Catalog\Model\Product $product */
$product = $block->getProduct();

if (!$product) {
    return;
}

$productName = $block->escapeHtml($product->getName());

/** @var \Magento\Framework\Data\Collection $images */
$images = $product->getMediaGalleryImages();

// Don't render if no images
if (!$images || $images->getSize() === 0) {
    return;
}

// Get ViewModel
/** @var \Rollpix\ProductGallery\ViewModel\GalleryConfig $galleryConfig */
$galleryConfig = $block->getData('gallery_config');

// Get configuration from ViewModel
$layoutType = $galleryConfig->getLayoutType();
$zoomType = $galleryConfig->getZoomType();
$zoomLevel = $galleryConfig->getZoomLevel();
$zoomPosition = $galleryConfig->getZoomPosition();
$galleryPosition = $galleryConfig->getGalleryPosition();
$columnRatio = $galleryConfig->getColumnRatio();
$imageGap = $galleryConfig->getImageGap();
$mobileBehavior = $galleryConfig->getMobileBehavior();
$stickyEnabled = $galleryConfig->isStickyEnabled();
$stickyMode = $galleryConfig->getStickyMode();
$stickyOffset = $galleryConfig->getStickyOffset();

// Build CSS classes
$wrapperClasses = [
    'rp-product-gallery',
    'rp-layout-' . $layoutType,
    'rp-gallery-position-' . $galleryPosition,
    'rp-mobile-' . $mobileBehavior,
    'rp-zoom-' . $zoomType
];

if ($stickyEnabled) {
    $wrapperClasses[] = 'rp-sticky-' . $stickyMode;
}

if ($galleryConfig->isInlineTabsEnabled()) {
    $wrapperClasses[] = 'rp-inline-tabs';
}

$thumbnailPosition = $galleryConfig->getThumbnailPosition();
if ($thumbnailPosition !== 'disabled') {
    $wrapperClasses[] = 'rp-thumbnails-' . $thumbnailPosition;
}

if ($galleryConfig->isShimmerEnabled()) {
    $wrapperClasses[] = 'rp-shimmer';
}

if ($galleryConfig->isFadeInEnabled()) {
    $wrapperClasses[] = 'rp-fadein';
}

if ($galleryConfig->isCounterEnabled()) {
    $wrapperClasses[] = 'rp-counter';
}

// Get JS config
$jsConfig = $galleryConfig->getJsConfigJson();

// Get column CSS values
$columnCss = $galleryConfig->getColumnCss();
$gridImageColumns = $columnCss['gridImageColumns'] ?? 2;
?>

<style>
    .rp-product-wrapper {
        --rp-col-1: <?= $block->escapeHtmlAttr($columnCss['col1']) ?>;
        --rp-col-2: <?= $block->escapeHtmlAttr($columnCss['col2']) ?>;
        --rp-gallery-order: <?= (int)$columnCss['galleryOrder'] ?>;
        --rp-info-order: <?= (int)$columnCss['infoOrder'] ?>;
        --rp-sticky-offset: <?= (int)$stickyOffset ?>px;
        --rp-image-gap: <?= (int)$imageGap ?>px;
        <?php if ($layoutType === 'grid'): ?>
        --rp-grid-cols: <?= (int)$gridImageColumns ?>;
        <?php endif; ?>
    }
    <?php if (!$stickyEnabled): ?>
    .rp-product-wrapper .product-info-main {
        position: static !important;
    }
    <?php elseif ($stickyMode === 'frame'): ?>
    .rp-product-wrapper .product-info-main {
        max-height: calc(100vh - <?= (int)$stickyOffset ?>px - 20px);
        overflow-y: auto;
    }
    <?php else: /* scroll mode */ ?>
    .rp-product-wrapper .product-info-main {
        max-height: none;
        overflow-y: visible;
    }
    <?php endif; ?>
    @media screen and (max-width: 767px) {
        .rp-product-wrapper .product-info-main {
            position: relative !important;
            max-height: none !important;
            overflow-y: visible !important;
        }
    }
</style>

<div class="<?= $block->escapeHtmlAttr(implode(' ', $wrapperClasses)) ?>"
     data-role="rp-gallery"
     data-mage-init='{"rpGalleryZoom": <?= /* @noEscape */ $jsConfig ?>, "rpGalleryCarousel": <?= /* @noEscape */ $jsConfig ?>, "rpGalleryTabs": <?= /* @noEscape */ $jsConfig ?>, "rpGalleryEffects": <?= /* @noEscape */ $jsConfig ?>, "rpGalleryThumbnails": <?= /* @noEscape */ $jsConfig ?>, "rpGallerySlider": <?= /* @noEscape */ $jsConfig ?>}'>

    <div class="rp-gallery-images">
        <?php foreach ($images as $image): ?>
            <?php
            $largeImageUrl = $image->getData('large_image_url') ?: $image->getData('url');
            $mediumImageUrl = $image->getData('medium_image_url') ?: $image->getData('url');
            $imageLabel = $image->getData('label') ?: $productName;
            ?>
            <a href="<?= $block->escapeUrl($largeImageUrl) ?>"
               class="rp-gallery-item <?= $zoomType === 'lightbox' ? 'glightbox' : '' ?>"
               data-gallery="product-gallery"
               <?php if ($zoomType === 'lightbox'): ?>
               data-glightbox="title: <?= $block->escapeHtmlAttr($imageLabel) ?>"
               <?php endif; ?>>
                <img src="<?= $block->escapeUrl($mediumImageUrl) ?>"
                     alt="<?= $block->escapeHtmlAttr($imageLabel) ?>"
                     loading="lazy"/>
            </a>
        <?php endforeach; ?>
    </div>

    <?php if ($layoutType === 'slider'): ?>
    <button class="rp-slider-prev" type="button" aria-label="<?= $block->escapeHtmlAttr(__('Previous image')) ?>">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </button>
    <button class="rp-slider-next" type="button" aria-label="<?= $block->escapeHtmlAttr(__('Next image')) ?>">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
    </button>
    <div class="rp-slider-dots" data-role="rp-slider-dots"></div>
    <?php endif; ?>

    <?php if ($thumbnailPosition !== 'disabled'): ?>
    <div class="rp-thumbnail-strip" data-role="rp-thumbnails">
        <?php foreach ($images as $index => $image): ?>
            <?php
            $thumbUrl = $image->getData('small_image_url') ?: $image->getData('url');
            $thumbLabel = $image->getData('label') ?: $productName;
            ?>
            <button class="rp-thumbnail-item<?= $index === 0 ? ' rp-thumbnail-active' : '' ?>"
                    type="button"
                    data-thumb-index="<?= (int)$index ?>"
                    aria-label="<?= $block->escapeHtmlAttr(__('Go to image %1', $index + 1)) ?>">
                <img src="<?= $block->escapeUrl($thumbUrl) ?>"
                     alt="<?= $block->escapeHtmlAttr($thumbLabel) ?>"
                     loading="lazy"/>
            </button>
        <?php endforeach; ?>
    </div>
    <?php endif; ?>
</div>
